/****************************************************************************
 Titre	:   Gestion des sequences pre definies
 Auteur:    LeBomb
 Date:      13/09/2006
 Software:  WinAVR
 Cible:     Microcontroleur Atmel AT90S4414/8515/Mega

 DESCRIPTION
       Utilise les fonctions de gestion des sequences des servomoteurs
 UTILISATION
       Liste des fonctions utiles dans sequences.h.
*****************************************************************************/

# include "blue.h"
# include "delay.h"
# include "eth.h"
# include "global.h"
# include "sequences.h"
# include "timer.h"

void (*CMDES[MAX_CDES])(void);
volatile u16 nb_pasAvant   = 0;
volatile u16 nb_pasArriere = 0;
volatile u16 nb_pasTDroite = 0;
volatile u16 nb_pasTGauche = 0;
volatile u16 nb_pasDroite  = 0;
volatile u16 nb_pasGauche  = 0;
volatile u16 nb_pas2P      = 0;
volatile u16 nb_pas3P      = 0;
volatile u16 nb_pas6P      = 0;
volatile u08 no_patte      = 0;
volatile u08 current_servo = 0;
volatile u08 seq           = 0;
volatile u08 mode          = MODE_DEFAULT;

const u16 unPasAvant  [18][NB_PATTES][NB_SERVO_PAR_PATTE] PROGMEM = {
{{1387,  360,  934}, {1371,  360, 1307}, { 646, 1420, 1103}, {1350,  920,  980}, { 377, 1460, 1163}, { 407, 1487, 1283}},
{{1403,  360,  908}, {1377,  360, 1273}, { 664, 1420, 1077}, {1610,  920,  600}, { 383, 1460, 1197}, { 387, 1483, 1311}},
{{1420,  360,  882}, {1382,  360, 1240}, { 682, 1420, 1050}, {1610,  460,  600}, { 390, 1460, 1230}, { 368, 1480, 1338}},
{{1437,  360,  856}, {1388,  360, 1207}, { 700, 1420, 1023}, {1593,  460,  625}, { 390, 1000, 1230}, { 349, 1477, 1365}},
{{1453,  360,  830}, {1388,  360, 1173}, { 718, 1420,  997}, {1575,  460,  651}, { 390, 1000,  730}, { 329, 1473, 1393}},
{{1470,  360,  804}, {1382,  360, 1140}, { 736, 1420,  970}, {1558,  460,  676}, { 390, 1460,  730}, { 310, 1470, 1420}},
{{1487,  360,  778}, {1377,  360, 1107}, { 754, 1420,  943}, {1541,  460,  701}, { 383, 1460,  763}, { 310, 1000, 1420}},
{{1503,  360,  752}, {1371,  360, 1073}, { 772, 1420,  917}, {1523,  460,  727}, { 377, 1460,  794}, { 600, 1000, 1010}},
{{1520,  360,  726}, {1366,  360, 1040}, { 790, 1420,  890}, {1506,  460,  752}, { 370, 1460,  830}, { 600, 1520, 1010}},
{{1537,  360,  700}, {1361,  360, 1007}, { 790,  960,  890}, {1489,  460,  777}, { 363, 1460,  863}, { 581, 1517, 1037}},
{{1553,  360,  674}, {1355,  360,  973}, { 520,  960, 1290}, {1471,  460,  803}, { 357, 1460,  897}, { 561, 1513, 1065}},
{{1570,  360,  648}, {1350,  360,  940}, { 520, 1420, 1290}, {1454,  460,  828}, { 350, 1460,  930}, { 542, 1510, 1092}},
{{1587,  360,  622}, {1350,  830,  940}, { 538, 1420, 1263}, {1437,  460,  853}, { 343, 1460,  963}, { 523, 1507, 1119}},
{{1603,  360,  596}, {1350,  830, 1440}, { 556, 1420, 1237}, {1419,  460,  878}, { 343, 1460,  997}, { 503, 1503, 1147}},
{{1620,  360,  570}, {1350,  360, 1440}, { 574, 1420, 1210}, {1402,  460,  904}, { 350, 1460, 1030}, { 484, 1500, 1174}},
{{1620,  780,  570}, {1355,  360, 1407}, { 592, 1420, 1183}, {1385,  460,  929}, { 357, 1460, 1063}, { 465, 1497, 1201}},
{{1400,  780,  960}, {1361,  360, 1373}, { 610, 1420, 1157}, {1367,  460,  955}, { 363, 1460, 1097}, { 445, 1493, 1229}},
{{1370,  360,  960}, {1366,  360, 1340}, { 628, 1420, 1130}, {1350,  460,  980}, { 370, 1460, 1130}, { 426, 1490, 1256}}};

const u16 unPasArriere[18][NB_PATTES][NB_SERVO_PAR_PATTE] PROGMEM = {
{{1400,  780,  960}, {1361,  360, 1373}, { 610, 1420, 1157}, {1367,  460,  955}, { 363, 1460, 1097}, { 445, 1493, 1229}},
{{1620,  780,  570}, {1355,  360, 1407}, { 592, 1420, 1183}, {1385,  460,  929}, { 357, 1460, 1063}, { 465, 1497, 1201}},
{{1620,  360,  570}, {1350,  360, 1440}, { 574, 1420, 1210}, {1402,  460,  904}, { 350, 1460, 1030}, { 484, 1500, 1174}},
{{1603,  360,  596}, {1350,  830, 1440}, { 556, 1420, 1237}, {1419,  460,  878}, { 343, 1460,  997}, { 503, 1503, 1147}},
{{1587,  360,  622}, {1350,  830,  940}, { 538, 1420, 1263}, {1437,  460,  853}, { 343, 1460,  963}, { 523, 1507, 1119}},
{{1570,  360,  648}, {1350,  360,  940}, { 520, 1420, 1290}, {1454,  460,  828}, { 350, 1460,  930}, { 542, 1510, 1092}},
{{1553,  360,  674}, {1355,  360,  973}, { 520,  960, 1290}, {1471,  460,  803}, { 357, 1460,  897}, { 561, 1513, 1065}},
{{1537,  360,  700}, {1361,  360, 1007}, { 790,  960,  890}, {1489,  460,  777}, { 363, 1460,  863}, { 581, 1517, 1037}},
{{1520,  360,  726}, {1366,  360, 1040}, { 790, 1420,  890}, {1506,  460,  752}, { 370, 1460,  830}, { 600, 1520, 1010}},
{{1503,  360,  752}, {1371,  360, 1073}, { 772, 1420,  917}, {1523,  460,  727}, { 377, 1460,  794}, { 600, 1000, 1010}},
{{1487,  360,  778}, {1377,  360, 1107}, { 754, 1420,  943}, {1541,  460,  701}, { 383, 1460,  763}, { 310, 1000, 1420}},
{{1470,  360,  804}, {1382,  360, 1140}, { 736, 1420,  970}, {1558,  460,  676}, { 390, 1460,  730}, { 310, 1470, 1420}},
{{1453,  360,  830}, {1388,  360, 1173}, { 718, 1420,  997}, {1575,  460,  651}, { 390, 1000,  730}, { 329, 1473, 1393}},
{{1437,  360,  856}, {1388,  360, 1207}, { 700, 1420, 1023}, {1593,  460,  625}, { 390, 1000, 1230}, { 349, 1477, 1365}},
{{1420,  360,  882}, {1382,  360, 1240}, { 682, 1420, 1050}, {1610,  460,  600}, { 390, 1460, 1230}, { 368, 1480, 1338}},
{{1403,  360,  908}, {1377,  360, 1273}, { 664, 1420, 1077}, {1610,  920,  600}, { 383, 1460, 1197}, { 387, 1483, 1311}},
{{1387,  360,  934}, {1371,  360, 1307}, { 646, 1420, 1103}, {1350,  920,  980}, { 377, 1460, 1163}, { 407, 1487, 1283}},
{{1370,  360,  960}, {1366,  360, 1340}, { 628, 1420, 1130}, {1350,  460,  980}, { 370, 1460, 1130}, { 426, 1490, 1256}}};

const u16 unPasTGauche[18][NB_PATTES][NB_SERVO_PAR_PATTE] PROGMEM = {
{{1490,  780,  960}, {1390,  360, 1373}, { 650, 1420, 1157}, {1480,  460,  625}, { 390, 1460,  863}, { 455, 1497, 1201}},
{{1490,  780,  570}, {1390,  360, 1407}, { 650, 1420, 1183}, {1480,  460,  651}, { 390, 1460,  897}, { 455, 1493, 1229}},
{{1490,  360,  570}, {1390,  360, 1440}, { 650, 1420, 1210}, {1480,  460,  676}, { 390, 1460,  930}, { 455, 1490, 1256}},
{{1490,  360,  596}, {1390,  830, 1440}, { 650, 1420, 1237}, {1480,  460,  701}, { 390, 1460,  963}, { 455, 1487, 1283}},
{{1490,  360,  622}, {1390,  830,  940}, { 650, 1420, 1263}, {1480,  460,  727}, { 390, 1460,  997}, { 455, 1483, 1311}},
{{1490,  360,  648}, {1390,  360,  940}, { 650, 1420, 1290}, {1480,  460,  752}, { 390, 1460, 1030}, { 455, 1480, 1338}},
{{1490,  360,  674}, {1390,  360,  973}, { 650,  960, 1290}, {1480,  460,  777}, { 390, 1460, 1063}, { 455, 1477, 1365}},
{{1490,  360,  700}, {1390,  360, 1007}, { 650,  960,  890}, {1480,  460,  803}, { 390, 1460, 1097}, { 455, 1473, 1393}},
{{1490,  360,  726}, {1390,  360, 1040}, { 650, 1420,  890}, {1480,  460,  828}, { 390, 1460, 1130}, { 455, 1470, 1420}},
{{1490,  360,  752}, {1390,  360, 1073}, { 650, 1420,  917}, {1480,  460,  853}, { 390, 1460, 1163}, { 455, 1000, 1420}},
{{1490,  360,  778}, {1390,  360, 1107}, { 650, 1420,  943}, {1480,  460,  878}, { 390, 1460, 1197}, { 455, 1000, 1010}},
{{1470,  360,  804}, {1390,  360, 1140}, { 650, 1420,  970}, {1480,  460,  904}, { 390, 1460, 1230}, { 455, 1520, 1010}},
{{1490,  360,  830}, {1390,  360, 1173}, { 650, 1420,  997}, {1480,  460,  929}, { 390, 1000, 1230}, { 455, 1517, 1037}},
{{1490,  360,  856}, {1390,  360, 1207}, { 650, 1420, 1023}, {1480,  460,  955}, { 390, 1000,  730}, { 455, 1513, 1065}},
{{1490,  360,  882}, {1390,  360, 1240}, { 650, 1420, 1050}, {1480,  460,  980}, { 390, 1460,  730}, { 455, 1510, 1092}},
{{1490,  360,  908}, {1390,  360, 1273}, { 650, 1420, 1077}, {1480,  920,  980}, { 390, 1460,  763}, { 455, 1507, 1119}},
{{1490,  360,  934}, {1390,  360, 1307}, { 650, 1420, 1103}, {1480,  920,  600}, { 390, 1460,  794}, { 455, 1503, 1147}},
{{1490,  360,  960}, {1390,  360, 1340}, { 650, 1420, 1130}, {1480,  460,  600}, { 390, 1460,  830}, { 455, 1500, 1174}}};

const u16 unPasTDroite[18][NB_PATTES][NB_SERVO_PAR_PATTE] PROGMEM = {
{{1620,  780,  570}, {1355,  360,  973}, { 700, 1420, 1023}, {1367,  460,  955}, { 363, 1460, 1097}, { 445, 1493, 1229}},
{{1400,  780,  960}, {1361,  360, 1007}, { 718, 1420,  997}, {1385,  460,  929}, { 357, 1460, 1063}, { 465, 1497, 1201}},
{{1370,  360,  960}, {1350,  360,  940}, { 736, 1420,  970}, {1402,  460,  904}, { 350, 1460, 1030}, { 484, 1500, 1174}},
{{1387,  360,  934}, {1350,  830,  940}, { 754, 1420,  943}, {1419,  460,  878}, { 343, 1460,  997}, { 503, 1503, 1147}},
{{1403,  360,  908}, {1350,  830, 1440}, { 772, 1420,  917}, {1437,  460,  853}, { 343, 1460,  963}, { 523, 1507, 1119}},
{{1420,  360,  882}, {1350,  360, 1440}, { 790, 1420,  890}, {1454,  460,  828}, { 350, 1460,  930}, { 542, 1510, 1092}},
{{1437,  360,  856}, {1355,  360, 1407}, { 790,  960,  890}, {1471,  460,  803}, { 357, 1460,  897}, { 561, 1513, 1065}},
{{1453,  360,  830}, {1361,  360, 1373}, { 520,  960, 1290}, {1489,  460,  777}, { 363, 1460,  863}, { 581, 1517, 1037}},
{{1470,  360,  804}, {1366,  360, 1340}, { 520, 1420, 1290}, {1506,  460,  752}, { 370, 1460,  830}, { 600, 1520, 1010}},
{{1487,  360,  778}, {1371,  360, 1307}, { 538, 1420, 1263}, {1523,  460,  727}, { 377, 1460,  794}, { 600, 1000, 1010}},
{{1503,  360,  752}, {1377,  360, 1273}, { 556, 1420, 1237}, {1541,  460,  701}, { 383, 1460,  763}, { 310, 1000, 1420}},
{{1520,  360,  726}, {1382,  360, 1240}, { 574, 1420, 1210}, {1558,  460,  676}, { 390, 1460,  730}, { 310, 1470, 1420}},
{{1537,  360,  700}, {1388,  360, 1207}, { 592, 1420, 1183}, {1575,  460,  651}, { 390, 1000,  730}, { 329, 1473, 1393}},
{{1553,  360,  674}, {1388,  360, 1173}, { 610, 1420, 1157}, {1593,  460,  625}, { 390, 1000, 1230}, { 349, 1477, 1365}},
{{1570,  360,  648}, {1382,  360, 1140}, { 628, 1420, 1130}, {1610,  460,  600}, { 390, 1460, 1230}, { 368, 1480, 1338}},
{{1587,  360,  622}, {1377,  360, 1107}, { 646, 1420, 1103}, {1610,  920,  600}, { 383, 1460, 1197}, { 387, 1483, 1311}},
{{1603,  360,  596}, {1371,  360, 1073}, { 664, 1420, 1077}, {1350,  920,  980}, { 377, 1460, 1163}, { 407, 1487, 1283}},
{{1620,  360,  570}, {1366,  360, 1040}, { 682, 1420, 1050}, {1350,  460,  980}, { 370, 1460, 1130}, { 426, 1490, 1256}}};

const u16 unPasGauche [18][NB_PATTES][NB_SERVO_PAR_PATTE] PROGMEM = {
{{1380,  910, 1040}, {1312,  310, 1180}, { 840, 1470,  850}, {1352,  410, 1055}, { 464, 1489, 1000}, { 626, 1540, 1010}},
{{1230,  910,  880}, {1326,  310, 1180}, { 832, 1470,  840}, {1344,  410, 1040}, { 480, 1486, 1000}, { 630, 1540, 1020}},
{{1230,  310,  889}, {1340,  310, 1180}, { 824, 1470,  830}, {1336,  410, 1030}, { 496, 1483, 1000}, { 640, 1540, 1030}},
{{1242,  310,  898}, {1340,  910, 1180}, { 816, 1470,  820}, {1328,  410, 1020}, { 512, 1480, 1000}, { 650, 1540, 1040}},
{{1254,  310,  907}, {1090,  910, 1180}, { 808, 1470,  810}, {1320,  410, 1010}, { 528, 1480, 1000}, { 660, 1540, 1050}},
{{1266,  310,  916}, {1090,  310, 1180}, { 800, 1470,  800}, {1312,  410, 1000}, { 544, 1483, 1000}, { 670, 1540, 1060}},
{{1278,  310,  925}, {1108,  310, 1180}, { 800,  870,  800}, {1304,  410,  990}, { 560, 1486, 1000}, { 680, 1540, 1070}},
{{1290,  310,  934}, {1126,  310, 1180}, { 950,  870,  960}, {1290,  410,  983}, { 576, 1489, 1000}, { 695, 1540, 1080}},
{{1302,  310,  943}, {1144,  310, 1180}, { 950, 1470,  950}, {1280,  410,  974}, { 592, 1492, 1000}, { 710, 1540, 1090}},
{{1314,  310,  952}, {1162,  310, 1180}, { 938, 1470,  940}, {1270,  410,  965}, { 608, 1494, 1000}, { 710,  940, 1090}},
{{1324,  310,  956}, {1180,  310, 1180}, { 926, 1470,  930}, {1260,  410,  956}, { 624, 1497, 1000}, { 570,  940,  920}},
{{1332,  310,  968}, {1198,  310, 1180}, { 914, 1470,  920}, {1250,  410,  947}, { 640, 1500, 1000}, { 570, 1540,  920}},
{{1340,  310,  980}, {1216,  310, 1180}, { 890, 1470,  910}, {1240,  410,  938}, { 640,  900, 1000}, { 578, 1540,  932}},
{{1348,  310,  992}, {1230,  310, 1180}, { 878, 1470,  900}, {1230,  410,  929}, { 400,  900, 1000}, { 586, 1540,  944}},
{{1356,  310, 1004}, {1244,  310, 1180}, { 866, 1470,  890}, {1220,  410,  920}, { 400, 1500, 1000}, { 594, 1540,  956}},
{{1364,  310, 1016}, {1262,  310, 1180}, { 860, 1470,  880}, {1220,  910,  920}, { 416, 1497, 1000}, { 602, 1540,  968}},
{{1372,  310, 1028}, {1280,  310, 1180}, { 856, 1470,  870}, {1360, 1010, 1070}, { 432, 1494, 1000}, { 610, 1540,  980}},
{{1380,  310, 1040}, {1298,  310, 1180}, { 848, 1470,  860}, {1360,  410, 1070}, { 448, 1492, 1000}, { 618, 1540,  992}}};

const u16 unPasDroite [18][NB_PATTES][NB_SERVO_PAR_PATTE] PROGMEM = {
{{1372,  310, 1028}, {1280,  310, 1180}, { 856, 1470,  870}, {1360, 1010, 1070}, { 432, 1494, 1000}, { 610, 1540,  980}},
{{1364,  310, 1016}, {1262,  310, 1180}, { 860, 1470,  880}, {1220,  910,  920}, { 416, 1497, 1000}, { 602, 1540,  968}},
{{1356,  310, 1004}, {1244,  310, 1180}, { 866, 1470,  890}, {1220,  410,  920}, { 400, 1500, 1000}, { 594, 1540,  956}},
{{1348,  310,  992}, {1230,  310, 1180}, { 878, 1470,  900}, {1230,  410,  929}, { 400,  900, 1000}, { 586, 1540,  944}},
{{1340,  310,  980}, {1216,  310, 1180}, { 890, 1470,  910}, {1240,  410,  938}, { 640,  900, 1000}, { 578, 1540,  932}},
{{1332,  310,  968}, {1198,  310, 1180}, { 914, 1470,  920}, {1250,  410,  947}, { 640, 1500, 1000}, { 570, 1540,  920}},
{{1324,  310,  956}, {1180,  310, 1180}, { 926, 1470,  930}, {1260,  410,  956}, { 624, 1497, 1000}, { 570,  940,  920}},
{{1314,  310,  952}, {1162,  310, 1180}, { 938, 1470,  940}, {1270,  410,  965}, { 608, 1494, 1000}, { 710,  940, 1090}},
{{1302,  310,  943}, {1144,  310, 1180}, { 950, 1470,  950}, {1280,  410,  974}, { 592, 1492, 1000}, { 710, 1540, 1090}},
{{1290,  310,  934}, {1126,  310, 1180}, { 950,  870,  960}, {1290,  410,  983}, { 576, 1489, 1000}, { 695, 1540, 1080}},
{{1278,  310,  925}, {1108,  310, 1180}, { 800,  870,  800}, {1304,  410,  990}, { 560, 1486, 1000}, { 680, 1540, 1070}},
{{1266,  310,  916}, {1090,  310, 1180}, { 800, 1470,  800}, {1312,  410, 1000}, { 544, 1483, 1000}, { 670, 1540, 1060}},
{{1254,  310,  907}, {1090,  910, 1180}, { 808, 1470,  810}, {1320,  410, 1010}, { 528, 1480, 1000}, { 660, 1540, 1050}},
{{1242,  310,  898}, {1340,  910, 1180}, { 816, 1470,  820}, {1328,  410, 1020}, { 512, 1480, 1000}, { 650, 1540, 1040}},
{{1230,  310,  889}, {1340,  310, 1180}, { 824, 1470,  830}, {1336,  410, 1030}, { 496, 1483, 1000}, { 640, 1540, 1030}},
{{1230,  910,  880}, {1326,  310, 1180}, { 832, 1470,  840}, {1344,  410, 1040}, { 480, 1486, 1000}, { 630, 1540, 1020}},
{{1380,  910, 1040}, {1312,  310, 1180}, { 840, 1470,  850}, {1352,  410, 1055}, { 464, 1489, 1000}, { 626, 1540, 1010}},
{{1380,  310, 1040}, {1298,  310, 1180}, { 848, 1470,  860}, {1360,  410, 1070}, { 448, 1492, 1000}, { 618, 1540,  992}}};

const u16 unPas2P     [8 ][NB_PATTES][NB_SERVO_PAR_PATTE] PROGMEM = {
{{1420,  260,  882}, {1382,  260, 1240}, { 682, 1520, 1050}, {1350,  920,  980}, { 390, 1560, 1230}, { 368, 1020, 1338}},
{{1470,  260,  804}, {1382,  260, 1140}, { 736, 1520,  970}, {1610,  920,  600}, { 390, 1000, 1230}, { 310, 1170, 1420}},
{{1520,  260,  726}, {1366,  260, 1040}, { 790, 1520,  890}, {1610,  360,  600}, { 390, 1000,  730}, { 310, 1000, 1420}},
{{1570,  260,  648}, {1350,  260,  940}, { 790,  960,  890}, {1558,  360,  676}, { 390, 1560,  730}, { 600, 1000, 1010}},
{{1620,  260,  570}, {1350,  830,  940}, { 520,  960, 1290}, {1506,  360,  752}, { 370, 1552,  830}, { 600, 1220, 1010}},
{{1620,  780,  570}, {1350,  830, 1440}, { 520, 1520, 1290}, {1454,  360,  828}, { 350, 1544,  930}, { 542, 1170, 1092}},
{{1400,  780,  960}, {1350,  260, 1440}, { 574, 1520, 1210}, {1402,  360,  904}, { 350, 1544, 1030}, { 484, 1120, 1174}},
{{1370,  260,  960}, {1366,  260, 1340}, { 628, 1520, 1130}, {1350,  360,  980}, { 370, 1552, 1130}, { 426, 1070, 1256}}};

const u16 unPas3P     [8 ][NB_PATTES][NB_SERVO_PAR_PATTE] PROGMEM = {
{{1370,  460,  960}, {1350,  830,  940}, { 520, 1320, 1290}, {1350,  920,  980}, { 390, 1360,  730}, { 310, 1000, 1420}},
{{1490,  460,  760}, {1390,  830, 1190}, { 650, 1320, 1090}, {1480,  920,  790}, { 340, 1340,  980}, { 450, 1000, 1210}},
{{1620,  460,  570}, {1350,  830, 1440}, { 790, 1320,  890}, {1610,  920,  600}, { 390, 1360, 1230}, { 600, 1000, 1010}},
{{1620,  460,  570}, {1350,  460, 1440}, { 790, 1320,  890}, {1610,  560,  600}, { 390, 1360, 1230}, { 600, 1420, 1010}},
{{1620,  780,  570}, {1350,  460, 1440}, { 790,  960,  890}, {1610,  560,  600}, { 390, 1000, 1230}, { 600, 1420, 1010}},
{{1490,  780,  760}, {1390,  460, 1190}, { 650,  960, 1090}, {1480,  560,  790}, { 340, 1000,  980}, { 450, 1390, 1210}},
{{1400,  780,  960}, {1350,  460,  940}, { 520,  960, 1290}, {1350,  560,  980}, { 390, 1000,  730}, { 310, 1370, 1420}},
{{1370,  460,  960}, {1350,  460,  940}, { 520, 1320, 1290}, {1350,  560,  980}, { 390, 1360,  730}, { 310, 1370, 1420}}};

const u16 unPas6P     [5 ][NB_PATTES][NB_SERVO_PAR_PATTE] PROGMEM = {
{{1620,  460,  570}, {1350,  460,  940}, { 790, 1320,  890}, {1350,  560,  980}, { 390, 1360, 1230}, { 310, 1370, 1420}},
{{1620,  780,  570}, {1350,  830,  940}, { 790,  960,  890}, {1350,  920,  980}, { 390, 1000, 1230}, { 310, 1000, 1420}},
{{1400,  780,  960}, {1350,  830, 1440}, { 520,  960, 1290}, {1610,  920,  600}, { 390, 1000,  730}, { 600, 1000, 1010}},
{{1370,  460,  960}, {1350,  460, 1440}, { 520, 1320, 1290}, {1610,  560,  600}, { 390, 1360,  730}, { 600, 1420, 1010}},
{{1490,  460,  760}, {1390,  460, 1190}, { 650, 1320, 1090}, {1480,  560,  790}, { 340, 1340,  980}, { 450, 1390, 1210}}};

const u16 posMoyenne  [1 ][NB_PATTES][NB_SERVO_PAR_PATTE] PROGMEM = {
{{1370,  460,  960}, {1360,  460, 1180}, { 810, 1330,  870}, {1350,  540,  980}, { 400, 1340, 1000}, { 590, 1420, 1020}}};

const u16 posRepliee  [1 ][NB_PATTES][NB_SERVO_PAR_PATTE] PROGMEM = {
{{1900, 1240, 1120}, {1740, 1300, 1190}, {   0,  500,  580}, {1900, 1420, 1230}, {   0,  500, 1050}, {  30,  600,  900}}};

const u16 posTHaute   [1 ][NB_PATTES][NB_SERVO_PAR_PATTE] PROGMEM = {
{{1490,  160,  760}, {1390,  360, 1190}, { 650, 1120, 1090}, {1480,  660,  790}, { 340, 1460,  980}, { 450, 1690, 1210}}};

const u16 posTBasse   [1 ][NB_PATTES][NB_SERVO_PAR_PATTE] PROGMEM = {
{{1490,  560,  760}, {1390,  360, 1190}, { 650, 1520, 1090}, {1480,  260,  790}, { 340, 1460,  980}, { 450, 1290, 1210}}};

const u16 posHaute    [1 ][NB_PATTES][NB_SERVO_PAR_PATTE] PROGMEM = {
{{1290,  150,  960}, {1150,  120, 1180}, { 870, 1620,  870}, {1240,  240,  980}, { 610, 1670, 1000}, { 650, 1710, 1020}}};

const u16 posBasse    [1 ][NB_PATTES][NB_SERVO_PAR_PATTE] PROGMEM = {
{{1920,  850,  960}, {1730,  820, 1180}, { 210,  970,  870}, {1930,  950,  980}, {   0,  920, 1000}, {   0, 1040, 1020}}};

const u16 posTDroite  [1 ][NB_PATTES][NB_SERVO_PAR_PATTE] PROGMEM = {
{{1580,  850,    0}, {1470,  820,  220}, { 390,  970,  280}, {1590,  950,    0}, { 350, 1210,  150}, { 140, 1040,  130}}};

const u16 posTGauche  [1 ][NB_PATTES][NB_SERVO_PAR_PATTE] PROGMEM = {
{{1580,  850, 1830}, {1470,  700, 2000}, { 540,  970, 2000}, {1720,  950, 1500}, { 290, 1070, 1940}, { 320, 1040, 2000}}};

const u16 posDroite   [1 ][NB_PATTES][NB_SERVO_PAR_PATTE] PROGMEM = {
{{1580,  850,    0}, {1470,  820,  220}, { 390,  970,  280}, {1590,  950,    0}, { 350, 1210,  150}, { 140, 1040,  130}}};

const u16 posGauche   [1 ][NB_PATTES][NB_SERVO_PAR_PATTE] PROGMEM = {
{{1580,  850, 1830}, {1470,  700, 2000}, { 540,  970, 2000}, {1720,  950, 1500}, { 290, 1070, 1940}, { 320, 1040, 2000}}};

// Pas
void seq1PasAvant   (void) { seq1Step(unPasAvant,   (u16*) &nb_pasAvant,   2); }
void seq1PasArriere (void) { seq1Step(unPasArriere, (u16*) &nb_pasArriere, 2); }
void seq1PasTDroite (void) { seq1Step(unPasTDroite, (u16*) &nb_pasTDroite, 2); }
void seq1PasTGauche (void) { seq1Step(unPasTGauche, (u16*) &nb_pasTGauche, 2); }
void seq1PasDroite  (void) { seq1Step(unPasDroite,  (u16*) &nb_pasDroite,  2); }
void seq1PasGauche  (void) { seq1Step(unPasGauche,  (u16*) &nb_pasGauche,  2); }
void seq1Pas2Pattes (void) { seq1Step(unPas2P,      (u16*) &nb_pas2P,      2); }
void seq1Pas3Pattes (void) { seq1Step(unPas3P,      (u16*) &nb_pas3P,      2); }
void seq1Pas6Pattes (void) { seq1Step(unPas6P,      (u16*) &nb_pas6P,      2); }
// Positions
void seqPosMoyenne  (void) { seq1Step(posMoyenne,   0,                    100); }
void seqPosRepliee  (void) { seq1Step(posRepliee,   0,                     50); }
void seqPosTHaute   (void) { seq1Step(posTHaute,    0,                     50); }
void seqPosTBasse   (void) { seq1Step(posTBasse,    0,                    100); }
void seqPosHaute    (void) { seq1Step(posHaute,     0,                     50); }
void seqPosBasse    (void) { seq1Step(posBasse,     0,                    100); }
void seqPosTDroite  (void) { seq1Step(posTDroite,   0,                     50); }
void seqPosTGauche  (void) { seq1Step(posTGauche,   0,                     50); }
void seqPosDroite   (void) { seq1Step(posDroite,    0,                     50); }
void seqPosGauche   (void) { seq1Step(posGauche,    0,                     50); }
// Gestion independante des pattes
void nextPatte      (void) { no_patte++; if(no_patte>=NB_PATTES) { no_patte=0; } current_servo=p2s(no_patte,0); uart_puts((u08*) "Patte selectionnee : "); uart_putd('d',no_patte); uart_puts((u08*) "\n"); }
void seg0moins      (void) { addMov_rel(current_servo,    10, 10); }
void seg0norm       (void) { addMov_abs(current_servo,   servo[current_servo].repos, 10); }
void seg0plus       (void) { addMov_rel(current_servo,   -10, 10); }
void seg1moins      (void) { addMov_rel(current_servo+1,  10, 10); }
void seg1norm       (void) { addMov_abs(current_servo+1, servo[current_servo+1].repos, 10); }
void seg1plus       (void) { addMov_rel(current_servo+1, -10, 10); }
void seg2moins      (void) { addMov_rel(current_servo+2,  10, 10); }
void seg2norm       (void) { addMov_abs(current_servo+2, servo[current_servo+2].repos, 10); }
void seg2plus       (void) { addMov_rel(current_servo+2, -10, 10); }
// Camera
void cameraHaut     (void) { addMov_rel(9,  100, 10); }
void cameraBas      (void) { addMov_rel(9, -100, 10); }
void cameraGauche   (void) { addMov_rel(10,  100, 10); }
void cameraDroite   (void) { addMov_rel(10, -100, 10); }

void init_pas(void);
void change_mode(void);
void help(void);
void init_sequences(void)
{
  u16 i=0;
  seq           = 0;
  current_servo = 0;
  mode          = MODE_DEFAULT;
  init_pas();
  for(i=0; i<MAX_CDES; i++)
  {
    CMDES[i]=0;
  }
  CMDES['a']=&seqPosMoyenne;
  CMDES['z']=&seqPosRepliee;
  CMDES['e']=&seqPosTHaute;
  CMDES['r']=&seqPosTBasse;
  CMDES['t']=&seqPosHaute;
  CMDES['y']=&seqPosBasse;
  CMDES['u']=&seqPosTDroite;
  CMDES['i']=&seqPosTGauche;
  CMDES['o']=&seqPosDroite;
  CMDES['p']=&seqPosGauche;
  CMDES['q']=&seq1PasAvant;
  CMDES['w']=&seq1PasArriere;
  CMDES['c']=&seq1PasTDroite;
  CMDES['x']=&seq1PasTGauche;
  CMDES['b']=&seq1PasDroite;
  CMDES['v']=&seq1PasGauche;
  CMDES['s']=&seq1Pas2Pattes;
  CMDES['d']=&seq1Pas3Pattes;
  CMDES['f']=&seq1Pas6Pattes;
  CMDES[' ']=&nextPatte;
  CMDES['1']=&seg0moins;
  CMDES['4']=&seg0norm;
  CMDES['7']=&seg0plus;
  CMDES['2']=&seg1moins;
  CMDES['5']=&seg1norm;
  CMDES['8']=&seg1plus;
  CMDES['3']=&seg2moins;
  CMDES['6']=&seg2norm;
  CMDES['9']=&seg2plus;
  CMDES['g']=&change_mode;
  CMDES['h']=&help;
  CMDES['j']=&cameraHaut;
  CMDES['k']=&cameraBas;
  CMDES['l']=&cameraGauche;
  CMDES['m']=&cameraDroite;
  CMDES[0]=0;
}

void init_pas(void)
{
  nb_pasAvant   = 0;
  nb_pasArriere = 0;
  nb_pasTDroite = 0;
  nb_pasTGauche = 0;
  nb_pasDroite  = 0;
  nb_pasGauche  = 0;
  nb_pas2P      = 0;
  nb_pas3P      = 0;
  nb_pas6P      = 0;
}

void commandes(u08* cmd)
{
  if(*cmd)
  {
    if((*cmd == 'q') || ((mode == MODE_PILOT) && (*cmd == '8')))
    { nb_pasAvant++; }
    else if((*cmd == 'w') || ((mode == MODE_PILOT) && (*cmd == '2')))
    { nb_pasArriere++; }
    else if((*cmd == 'c') || ((mode == MODE_PILOT) && (*cmd == '6')))
    { nb_pasTDroite++; }
    else if((*cmd == 'x') || ((mode == MODE_PILOT) && (*cmd == '4')))
    { nb_pasTGauche++; }
    else if((*cmd == 'b') || ((mode == MODE_PILOT) && (*cmd == '9')))
    { nb_pasDroite++; }
    else if((*cmd == 'v') || ((mode == MODE_PILOT) && (*cmd == '7')))
    { nb_pasGauche++; }
    else if(*cmd == 's')
    { nb_pas2P++; }
    else if(*cmd == 'd')
    { nb_pas3P++; }
    else if(*cmd == 'f')
    { nb_pas6P++; }

    seq = *cmd;
    *cmd=0;
  }
}

void sequences(void)
{
  u08 i=0;
  static u08 seq_tmp=0;
  delay_ms(20);
  if(((seq)!=0) && (CMDES[seq]!=0))
  {
    if(CMDES[seq_tmp]!=CMDES[seq])
    {
      seq_tmp=seq;
      init_pas();
      jump_sequences(0);
    }
    seq=0;
  }
  if(CMDES[seq_tmp]!=0)
  {
    for(i=0; i<NB_SERVO; i++)
    { servo[i].in_seq=0; }
    (*CMDES[seq_tmp])();
    if(end_sequence())
    {
      seq_tmp=0;
      uart_puts((u08*) "Valeurs Servos : "); uart_putd('d',(U16_MAX-PERIODE_1MS)-servo[p2s(no_patte,0)].value); uart_puts((u08*) " "); uart_putd('d',(U16_MAX-PERIODE_1MS)-servo[p2s(no_patte,1)].value); uart_puts((u08*) " "); uart_putd('d',(U16_MAX-PERIODE_1MS)-servo[p2s(no_patte,2)].value); uart_puts((u08*) "\n");
    }
  }
}

void change_mode(void)
{
  mode++;
  if(mode>=NB_MODE)
  { mode = MODE_DEFAULT; }
  if(mode==MODE_REGLAGE)
  {
    CMDES['1']=&seg0moins;
    CMDES['4']=&seg0norm;
    CMDES['7']=&seg0plus;
    CMDES['2']=&seg1moins;
    CMDES['5']=&seg1norm;
    CMDES['8']=&seg1plus;
    CMDES['3']=&seg2moins;
    CMDES['6']=&seg2norm;
    CMDES['9']=&seg2plus;
    uart_puts((u08*) "########## Mode REGLAGE ##########\n");
  }
  else if(mode==MODE_PILOT)
  {
    CMDES['1']=&seqPosTHaute;
    CMDES['4']=&seq1PasTGauche;
    CMDES['7']=&seq1PasGauche;
    CMDES['2']=&seq1PasArriere;
    CMDES['5']=&seqPosMoyenne;
    CMDES['8']=&seq1PasAvant;
    CMDES['3']=&seqPosTBasse;
    CMDES['6']=&seq1PasTDroite;
    CMDES['9']=&seq1PasDroite;
    uart_puts((u08*) "########## Mode PILOTAGE ##########\n");
  }
}
// Aide
void help(void)
{
uart_puts_P((const u08*) PSTR("\
########## Aide ##########\n\
Commandes :\n\
  'a' : seqPosMoyenne\n\
  'z' : seqPosRepliee\n\
  'e' : seqPosTHaute\n\
  'r' : seqPosTBasse\n\
  't' : seqPosHaute\n\
  'y' : seqPosBasse\n\
  'u' : seqPosTDroite\n\
  'i' : seqPosTGauche\n\
  'o' : seqPosDroite\n\
  'p' : seqPosGauche\n\
  'q' : seq1PasAvant\n\
  'w' : seq1PasArriere\n\
  'c' : seq1PasTDroite\n\
  'x' : seq1PasTGauche\n\
  'b' : seq1PasDroite\n\
  'v' : seq1PasGauche\n\
  's' : seq1Pas2Pattes\n\
  'd' : seq1Pas3Pattes\n\
  'f' : seq1Pas6Pattes\n\
  ' ' : nextPatte\n\
  '1' : seg0moins\n\
  '4' : seg0norm\n\
  '7' : seg0plus\n\
  '2' : seg1moins\n\
  '5' : seg1norm\n\
  '8' : seg1plus\n\
  '3' : seg2moins\n\
  '6' : seg2norm\n\
  '9' : seg2plus\n\
  'g' : change_mode\n\
  'h' : help\n\
  'j' : cameraHaut\n\
  'k' : cameraBas\n\
  'l' : cameraGauche\n\
  'm' : cameraDroite\n\
############################\n"));
}
